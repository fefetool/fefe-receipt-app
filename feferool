import streamlit as st
import pandas as pd
from io import BytesIO
from docx import Document
from datetime import datetime
import os
import zipfile
from tempfile import NamedTemporaryFile
from docx.shared import Inches
from PIL import Image
import base64

# åŸºæœ¬è¨­å®š
st.set_page_config(page_title="æ™ºæ…§æ†‘è­‰ç”Ÿæˆç³»çµ±", layout="wide")
st.title("ğŸ“„ æ™ºæ…§æ†‘è­‰ç”Ÿæˆç³»çµ±")

# åˆå§‹åŒ– session state
def init_session_state():
    if 'field_mappings' not in st.session_state:
        st.session_state.field_mappings = []
    if 'logo_position' not in st.session_state:
        st.session_state.logo_position = "top-right"
    if 'image_position' not in st.session_state:
        st.session_state.image_position = "below-center"

init_session_state()

# æª”æ¡ˆä¸Šå‚³å€
st.header("1. æ–‡ä»¶ä¸Šå‚³")
col1, col2 = st.columns(2)
with col1:
    excel_file = st.file_uploader("ğŸ“Š ä¸Šå‚³ Excel æ”¶æ”¯æ˜ç´°", type=["xlsx"], key="excel_uploader")
with col2:
    word_template = st.file_uploader("ğŸ“„ ä¸Šå‚³ Word æ†‘è­‰æ¨¡æ¿", type=["docx"], key="word_uploader")

# æ—¥æœŸæ ¼å¼é¸æ“‡
st.header("2. æ—¥æœŸæ ¼å¼è¨­å®š")
date_format = st.selectbox(
    "é¸æ“‡æ—¥æœŸé¡¯ç¤ºæ ¼å¼ï¼š",
    ["è¥¿å…ƒå¹´ (2025å¹´4æœˆ1æ—¥)", "æ°‘åœ‹å¹´ (æ°‘åœ‹114å¹´4æœˆ1æ—¥)"],
    key="date_format"
)

# æ¬„ä½å°æ‡‰ç³»çµ±
st.header("3. æ¬„ä½å°æ‡‰è¨­å®š")
st.info("è«‹è¨­å®šWordæ¨¡æ¿ä¸­çš„æ¨™è¨˜æ–‡å­—èˆ‡Excelæ¬„ä½çš„å°æ‡‰é—œä¿‚")

if 'field_mappings' not in st.session_state:
    st.session_state.field_mappings = []

with st.form("field_mapping_form"):
    cols = st.columns(2)
    with cols[0]:
        template_field = st.text_input("æ¨¡æ¿æ¬„ä½åç¨± (å¦‚: {{æ—¥æœŸ}})", key="template_field")
    with cols[1]:
        if excel_file:
            df = pd.read_excel(excel_file)
            excel_field = st.selectbox("å°æ‡‰ Excel æ¬„ä½", df.columns.tolist(), key="excel_field")
        else:
            excel_field = st.text_input("å°æ‡‰ Excel æ¬„ä½åç¨±", key="excel_field_text")
    
    if st.form_submit_button("â• æ–°å¢æ¬„ä½å°æ‡‰"):
        if template_field and excel_field:
            st.session_state.field_mappings.append({
                'template_field': template_field,
                'excel_field': excel_field
            })
            st.success("æ¬„ä½å°æ‡‰å·²æ–°å¢ï¼")

# é¡¯ç¤ºå·²è¨­å®šçš„æ¬„ä½å°æ‡‰
if st.session_state.field_mappings:
    st.markdown("**å·²è¨­å®šå°æ‡‰æ¬„ä½**")
    for i, mapping in enumerate(st.session_state.field_mappings):
        cols = st.columns([1, 1, 0.2])
        with cols[0]:
            st.text_input(f"æ¨¡æ¿æ¬„ä½ {i+1}", value=mapping['template_field'], key=f"template_{i}", disabled=True)
        with cols[1]:
            st.text_input(f"Excelæ¬„ä½ {i+1}", value=mapping['excel_field'], key=f"excel_{i}", disabled=True)
        with cols[2]:
            if st.button("âŒ", key=f"delete_{i}"):
                st.session_state.field_mappings.pop(i)
                st.rerun()

# åœ–ç‰‡è¨­å®š
st.header("4. åœ–ç‰‡è¨­å®š")
logo_cols = st.columns(2)
with logo_cols[0]:
    logo_file = st.file_uploader("ä¸Šå‚³ LOGO åœ–ç‰‡", type=["png", "jpg"], key="logo_uploader")
with logo_cols[1]:
    logo_position = st.selectbox(
        "LOGO ä½ç½®ï¼š",
        ["å·¦ä¸Š", "å·¦ä¸‹", "å³ä¸Š", "å³ä¸‹"],
        key="logo_position"
    )

image_cols = st.columns(2)
with image_cols[0]:
    image_file = st.file_uploader("ä¸Šå‚³é™„åŠ åœ–ç‰‡", type=["png", "jpg"], key="image_uploader")
with image_cols[1]:
    image_position = st.selectbox(
        "åœ–ç‰‡ä½ç½®ï¼š",
        ["è¡¨æ ¼ä¸‹æ–¹ç½®ä¸­", "è¡¨æ ¼ä¸‹æ–¹ç½®å·¦", "è¡¨æ ¼ä¸‹æ–¹ç½®å³"],
        key="image_position"
    )

# åŒ¯å‡ºè¨­å®š
st.header("5. åŒ¯å‡ºè¨­å®š")
pdf_export = st.checkbox("åŒæ™‚åŒ¯å‡º PDF æ ¼å¼", key="pdf_export")

if st.button("ğŸš€ é–‹å§‹ç”¢å‡ºæ†‘è­‰æ–‡ä»¶", type="primary", key="generate_button"):
    if not word_template or not excel_file:
        st.error("è«‹ä¸Šå‚³ Excel å’Œ Word æ¨¡æ¿æ–‡ä»¶ï¼")
    elif not st.session_state.field_mappings:
        st.error("è«‹è‡³å°‘è¨­å®šä¸€çµ„æ¬„ä½å°æ‡‰ï¼")
    else:
        with st.spinner("æ­£åœ¨ç”Ÿæˆæ†‘è­‰æ–‡ä»¶..."):
            try:
                # æ–‡ä»¶ç”Ÿæˆé‚è¼¯
                df = pd.read_excel(excel_file)
                template = Document(word_template)
                master = Document()
                
                # è™•ç†æ¯å€‹æ¢ç›®
                for _, row in df.iterrows():
                    doc = Document(word_template)
                    for para in doc.paragraphs:
                        for mapping in st.session_state.field_mappings:
                            if mapping['template_field'] in para.text:
                                value = row[mapping['excel_field']]
                                # æ—¥æœŸæ ¼å¼è™•ç†
                                if 'æ—¥æœŸ' in mapping['template_field']:
                                    if isinstance(value, pd.Timestamp):
                                        if date_format.startswith("æ°‘åœ‹"):
                                            value = f"æ°‘åœ‹{value.year - 1911}å¹´{value.month}æœˆ{value.day}æ—¥"
                                        else:
                                            value = f"{value.year}å¹´{value.month}æœˆ{value.day}æ—¥"
                                para.text = para.text.replace(mapping['template_field'], str(value))
                    
                    # æ·»åŠ åˆ°ä¸»æ–‡ä»¶
                    for element in doc.element.body:
                        master.element.body.append(element)
                    master.add_page_break()

                # è™•ç†åœ–ç‰‡
                if logo_file:
                    add_image_to_doc(master, logo_file, logo_position, is_logo=True)
                
                if image_file:
                    add_image_to_doc(master, image_file, image_position, is_logo=False)

                # å„²å­˜æ–‡ä»¶
                output = BytesIO()
                master.save(output)
                output.seek(0)

                # æº–å‚™ä¸‹è¼‰
                output_filename = f"fefetool_{datetime.today().strftime('%Y%m%d')}"
                
                # å»ºç«‹ZIPæª”æ¡ˆ
                zip_buffer = BytesIO()
                with zipfile.ZipFile(zip_buffer, 'a', zipfile.ZIP_DEFLATED, False) as zip_file:
                    zip_file.writestr(f"{output_filename}.docx", output.getvalue())
                    
                    if pdf_export:
                        try:
                            from docx2pdf import convert
                            with NamedTemporaryFile(suffix='.docx', delete=False) as tmp_docx:
                                tmp_docx.write(output.getvalue())
                                tmp_docx_path = tmp_docx.name
                            
                            pdf_path = f"{output_filename}.pdf"
                            convert(tmp_docx_path, pdf_path)
                            
                            with open(pdf_path, 'rb') as pdf_file:
                                zip_file.writestr(f"{output_filename}.pdf", pdf_file.read())
                            os.unlink(pdf_path)
                            os.unlink(tmp_docx_path)
                        except Exception as e:
                            st.warning(f"PDFè½‰æ›å¤±æ•—: {str(e)}")

                zip_buffer.seek(0)
                
                # é¡¯ç¤ºä¸‹è¼‰æŒ‰éˆ•
                st.success("æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼")
                st.download_button(
                    label="â¬‡ï¸ ä¸‹è¼‰ ZIP æª”æ¡ˆ",
                    data=zip_buffer,
                    file_name=f"{output_filename}.zip",
                    mime="application/zip"
                )

            except Exception as e:
                st.error(f"ç”Ÿæˆæ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤: {str(e)}")

def add_image_to_doc(doc, image_file, position, is_logo=False):
    """æ·»åŠ åœ–ç‰‡åˆ°Wordæ–‡ä»¶"""
    img_path = NamedTemporaryFile(delete=False, suffix=".png").name
    with open(img_path, 'wb') as f:
        f.write(image_file.getvalue())
    
    try:
        # èª¿æ•´åœ–ç‰‡å¤§å°
        img = Image.open(img_path)
        width, height = img.size
        max_width = Inches(6.5) if not is_logo else Inches(1.5)
        ratio = min(max_width / width, 1.0)
        new_width = int(width * ratio)
        new_height = int(height * ratio)
        
        if is_logo:  # LOGOè™•ç†
            section = doc.sections[0]
            header = section.header
            paragraph = header.paragraphs[0] if header.paragraphs else header.add_paragraph()
            
            # ä½ç½®å°é½Š
            if "å·¦" in position:
                paragraph.alignment = 0  # å·¦å°é½Š
            elif "å³" in position:
                paragraph.alignment = 2  # å³å°é½Š
            
            run = paragraph.add_run()
            run.add_picture(img_path, width=Inches(1.5))
        
        else:  # é™„åŠ åœ–ç‰‡è™•ç†
            paragraph = doc.add_paragraph()
            if "ç½®ä¸­" in position:
                paragraph.alignment = 1  # ç½®ä¸­
            elif "å³" in position:
                paragraph.alignment = 2  # å³å°é½Š
            else:
                paragraph.alignment = 0  # å·¦å°é½Š
            
            run = paragraph.add_run()
            run.add_picture(img_path, width=Inches(4.0))
    
    finally:
        os.unlink(img_path)

# ç¯„ä¾‹æ¨¡æ¿ä¸‹è¼‰
st.sidebar.markdown("## ç¯„ä¾‹æ¨¡æ¿ä¸‹è¼‰")
st.sidebar.download_button(
    label="ğŸ“¥ ä¸‹è¼‰ç¯„ä¾‹ Excel",
    data=open("templates/sample_data.xlsx", "rb").read(),
    file_name="sample_data.xlsx",
    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
)
st.sidebar.download_button(
    label="ğŸ“¥ ä¸‹è¼‰ç¯„ä¾‹ Word æ¨¡æ¿",
    data=open("templates/sample_template.docx", "rb").read(),
    file_name="sample_template.docx",
    mime="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
)
